# Проект StandUP

Пайплайн для загрузки аудио из плейлистов YouTube, транскрибирования аудио, извлечения списка тем с таймкодами, а также анализа аудио для определения моментов со смехом.

## Реализовано

![alt text](image.png)

*   **PostgreSQL**: Реляционная база данных для хранения метаданных и результатов обработки.
*   **MinIO**: S3-совместимое объектное хранилище для аудиофайлов.
*   **Docker**: Контейнеризация сервисов (PostgreSQL, MinIO).
*   **yt-dlp**: Загрузка контента с YouTube.
*   **mlx-whisper**: Транскрибация аудио на Apple Silicon.
*   **SoundAnalysis**: Фреймворк Apple для анализа звука (используется для детекции смеха).
*   **Gemini API**: Большая языковая модель для анализа текста.
*   **Pydantic**: Валидация данных.

## Дополнительно (обязательно для запуска)
*   **openai-gemini**: Gemini ➜ OpenAI API proxy. Для работы с Gemini без использования VPN, требуется деплой и получение своего proxy URL согласно - https://github.com/PublicAffairs/openai-gemini. Полезное описание на русском - https://habr.com/ru/articles/798123/.

## Требуемые доработки

1. Реализация модуля классификации текста (после llm_chapter, ~30 классов) через Gemini API. Интеграция в БД и настройка промта (требуемые техники промта: many-shots, CoT)

2. Удаление аудио из локального хранилища после завершения обработкии отдельного видео

3. Разбиение монолитного main.py и общий рефакторинг:
- Выделение паттернов обработки этапов пайплайна, обработка каждого этапа пайплайна
- Операции с базой данных
- Обработка ошибок

## Планируется реализовать

![alt text](image-1.png)

## Структура проекта

```txt
StandUP_project
├── .env                        # Файл с переменными окружения
├── .gitignore                  # Файл для исключения файлов из Git
├── docker-compose.yml          # Конфигурация для запуска сервисов в Docker
├── initdb/
│   └── init_schema.sql         # SQL-скрипт для инициализации схемы БД
├── pyproject.toml              # Определение зависимостей и метаданных проекта
├── README.md                   # Документация проекта
└── src/
    ├── config.py               # Конфигурация проекта (пути, ключи, настройки)
    ├── database.py             # Функции для работы с базой данных PostgreSQL
    ├── llm_chapter.py          # Функции для взаимодействия с Gemini API
    ├── main.py                 # Основной скрипт для запуска пайплайна
    ├── pydantic_models.py      # Pydantic-модели для валидации данных
    ├── sound_classifier.py     # Модуль для запуска Swift-скрипта анализа звука
    ├── sound_classifier        # Исполняемый файл Swift для анализа звука
    ├── sound_classifier.swift  # Исходный код Swift для анализа звука
    ├── transcribe.py           # Модуль для транскрибации аудио
    └── youtube_downloader.py   # Модуль для загрузки данных с YouTube
```



## Установка и запуск
0. **Обятазельно:** Выполнить деплой согласно - https://github.com/PublicAffairs/openai-gemini, получить proxy url и внести в .env файл.

1.  **Клонируйте репозиторий:**
    ```bash
    git clone <URL репозитория>
    cd StandUP_project
    ```

2.  **Создайте и настройте файл `.env`:**
    Создайте файл `.env` в корне проекта и заполнив его по следующему шаблону:
    ```env
    # PostgreSQL
    POSTGRES_DB=standup_db
    POSTGRES_USER=user
    POSTGRES_PASSWORD=password
    POSTGRES_HOST=localhost
    POSTGRES_PORT=5432

    # MinIO
    MINIO_ROOT_USER=minioadmin
    MINIO_ROOT_PASSWORD=minioadmin
    MINIO_DOMAIN=localhost:9000
    MINIO_AUDIO_BUCKET=audio-files

    # API Keys
    GEMINI_API_KEY=your_gemini_api_key

    # Proxy
    PROXY_URL=your_proxy_url
    ```

3.  **Запустите сервисы с помощью Docker Compose:**
    ```bash
    docker-compose up -d
    ```
    Эта команда запустит контейнеры с PostgreSQL и MinIO.

4.  **Установите зависимости Python:**
    ```bash
    uv sync
    ```

5.  **Запустите пайплайн:**
    Передайте URL плейлиста YouTube в качестве аргумента командной строки (url должен содержать часть "...&list=..."):
    ```bash
    uv run ./src/main.py "https://www.youtube.com/watch?v=MaVc3dqiEI4&list=PLcQngyvNgfmLi9eyV9reNMqu-pbdKErKr"
    ```

## Описание компонентов

### main.py

Основной файл, который управляет всем пайплайном обработки. Он выполняет следующие шаги:
1.  Принимает URL плейлиста YouTube.
2.  Получает метаданные для каждого видео в плейлисте.
3.  Проверяет, какие видео уже были обработаны и сохранены в БД.
4.  Для новых или необработанных видео последовательно выполняет:
    *   Загрузку аудио (`youtube_downloader.py`).
    *   Транскрибацию аудио в текст (`transcribe.py`).
    *   Анализ текста с помощью LLM для выделения тем (`llm.py`).
    *   Детекцию смеха в аудио (`sound_classifier.py`).
5.  Сохраняет все результаты в базу данных PostgreSQL.

### youtube_downloader.py

Отвечает за взаимодействие с YouTube.
*   `yt_playlist_extract_info`: Извлекает метаданные всего плейлиста.
*   `download_audio`: Скачивает аудиодорожку из видео, сохраняет ее локально и загружает в объектное хранилище MinIO.

### transcribe.py

Использует библиотеку `mlx-whisper` для преобразования аудиофайлов в текст. Включает логику постобработки для очистки и улучшения качества транскрипции.

### llm.py

Отправляет транскрибированный текст в Gemini API для анализа.
*   `format_json_to_tsv`: Преобразует результат транскрипции в формат TSV.
*   `format_text_with_llm`: Формирует промпт и отправляет запрос к LLM для получения структурированного ответа с темами и таймкодами.

### sound_classifier

Реализуют функцию детекции смеха.
*   `sound_classifier.swift`: Написан на Swift и использует нативный фреймворк `SoundAnalysis` от Apple для эффективного анализа аудио. Он принимает путь к файлу и параметры анализа, а затем выводит результат в формате JSON.
*   `sound_classifier.py`: Python-обертка, которая вызывает скомпилированный Swift-файл как подпроцесс и получает от него данные.

### database.py

Содержит функции для работы с базой данных PostgreSQL:
*   `get_db_connection`: Устанавливает соединение с БД.
*   `check_row_in_db`: Проверяет наличие записи о видео в базе.
*   `json_to_db`, `obj_to_db`: Обновляют данные в таблице.

### config.py

Централизованная конфигурация проекта с использованием `pydantic-settings`. Загружает настройки из `.env` файла, включая ключи API, параметры подключения к БД и настройки моделей.

### init_schema.sql

SQL-скрипт, который выполняется при первом запуске контейнера PostgreSQL и создает необходимую схему `standup_raw` и таблицу `process_video` для хранения данных.

### docker-compose.yml

Определяет и настраивает сервисы, необходимые для работы проекта:
*   `postgresql`: База данных PostgreSQL.
*   `minio`: S3-совместимое объектное хранилище.
*   `minio-setup`: Сервис для первоначальной настройки MinIO (создание бакетов).